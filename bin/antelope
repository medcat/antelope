#!/usr/bin/env ruby

$: << File.expand_path("../../lib", __FILE__) << Dir.pwd
require "antelope"
require "erb"

def get_classes
  Object.constants.
    reject { |c| c == :Config        }.
    map    { |c| Object.const_get(c) }.
    select { |c| c.is_a? Class       }
end

ARGV.each do |program|
  current_consts = get_classes

  load program

  parser = (get_classes - current_consts).
    select { |x| x < Antelope::Parser   }.
    first

  raise "No parser for #{program}!" unless parser

  r, c, fl, t = parser.generate

  file_name = File.basename(program, ".rb")

  File.open("#{file_name}.output", "w") do |f|
    f.write Antelope::Output.output(parser,
                                    :recognizer  => r,
                                    :constructor => c,
                                    :conflictor  => fl,
                                    :table       => t.table)
  end
end
